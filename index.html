<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>単語学習アプリ</title>
    <!-- Tailwind CSSを読み込みます -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fontsからモダンなフォントを読み込みます -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&family=Noto+Sans+JP:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* Noto Sans JPを優先し、英語部分はInterを使用する設定です */
        body {
            font-family: 'Inter', 'Noto Sans JP', sans-serif;
        }
        /* 和訳テキストが長くなった場合に備えて、改行を許可します */
        .translation {
            white-space: pre-wrap;
        }
        /* トグルスイッチのスタイル */
        .toggle-checkbox:checked {
            @apply: right-0 border-green-500;
            right: 0;
            border-color: #22c55e;
        }
        .toggle-checkbox:checked + .toggle-label {
            @apply: bg-green-500;
            background-color: #22c55e;
        }
    </style>
</head>
<body class="bg-slate-100 text-slate-800 flex flex-col items-center min-h-screen p-4">

    <div class="w-full max-w-md mx-auto">
        <h1 class="text-3xl md:text-4xl font-bold text-slate-900 mb-6 text-center">単語学習アプリ</h1>

        <!-- 読み込み中メッセージ -->
        <div id="loadingMessage" class="text-center p-8 bg-white rounded-2xl shadow-lg">
            <p class="text-xl text-slate-600">単語を読み込んでいます...</p>
        </div>

        <!-- アプリのメインコンテンツ（初期状態では非表示） -->
        <div id="appContent" class="hidden">
            <!-- 設定セクション -->
            <div class="flex flex-col sm:flex-row items-center justify-between gap-4 mb-6">
                <!-- カテゴリ選択 -->
                <div class="w-full sm:w-auto flex-grow">
                    <label for="categorySelect" class="sr-only">カテゴリ選択:</label>
                    <select id="categorySelect" onchange="filterByCategory()" class="w-full bg-white border border-slate-300 rounded-lg px-4 py-3 focus:ring-2 focus:ring-blue-500 focus:outline-none transition-shadow">
                        <option value="all">すべてのカテゴリ</option>
                    </select>
                </div>
                <!-- シャッフル切り替えスイッチ -->
                <div class="flex items-center gap-3 bg-white border border-slate-300 rounded-lg px-4 py-3">
                    <label for="shuffleToggle" class="text-slate-700 font-bold select-none">シャッフル</label>
                    <div class="relative inline-block w-10 align-middle select-none transition duration-200 ease-in">
                        <input type="checkbox" name="shuffleToggle" id="shuffleToggle" class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer" onchange="toggleShuffle()" checked/>
                        <label for="shuffleToggle" class="toggle-label block overflow-hidden h-6 rounded-full bg-slate-300 cursor-pointer"></label>
                    </div>
                </div>
            </div>

            <!-- 単語カード -->
            <div class="bg-white rounded-2xl shadow-lg p-6 md:p-8 text-center mb-6">
                <div class="word text-4xl md:text-5xl font-bold text-slate-900 mb-4 min-h-[60px] flex items-center justify-center" id="wordDisplay"></div>
                <div class="translation text-2xl md:text-3xl text-slate-600 mb-8 min-h-[80px]" id="translationDisplay"></div>
                
                <!-- 操作ボタン -->
                <div class="flex flex-col gap-3">
                    <button id="toggleAnswerBtn" onclick="toggleTranslation()" class="w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-700 transition-all shadow-md hover:shadow-lg transform hover:-translate-y-0.5">
                        答えを見る
                    </button>
                    <div class="grid grid-cols-3 gap-3">
                        <button onclick="previousWord()" class="w-full bg-slate-200 text-slate-800 font-bold py-3 px-4 rounded-lg hover:bg-slate-300 transition-all">
                            戻る
                        </button>
                        <button onclick="nextWord()" class="w-full bg-slate-200 text-slate-800 font-bold py-3 px-4 rounded-lg hover:bg-slate-300 transition-all">
                            次へ
                        </button>
                        <button onclick="markLearned()" class="w-full bg-green-500 text-white font-bold py-3 px-4 rounded-lg hover:bg-green-600 transition-all shadow-sm hover:shadow-md col-span-1">
                            覚えた
                        </button>
                    </div>
                </div>
            </div>

            <!-- 覚えた単語リスト -->
            <div id="learnedList" class="w-full bg-white rounded-2xl shadow-lg p-6 md:p-8">
                <h2 class="text-2xl font-bold text-slate-900 mb-4 text-left">覚えた単語一覧</h2>
                <ul id="learnedWords" class="list-disc list-inside space-y-2 text-left text-slate-700"></ul>
            </div>
        </div>
    </div>

    <script>
        // グローバル変数
        let words = [];
        let currentIndex = 0;
        let filteredWords = [];
        let isShuffleEnabled = true;
        let learnedWords = JSON.parse(localStorage.getItem("learnedWords")) || [];

        // GoogleスプレッドシートのURLとプロキシ設定
        const GOOGLE_SHEET_EXPORT_URL = 'https://docs.google.com/spreadsheets/d/1A1Z51H3IYKdqZlfP_OETBpsOJhClrjTs/export?format=csv&gid=1984241066';
        const PROXY_URL = 'https://api.allorigins.win/raw?url=';
        const SPREADSHEET_URL = PROXY_URL + encodeURIComponent(GOOGLE_SHEET_EXPORT_URL);

        /**
         * CSVテキストをパースしてオブジェクトの配列に変換します。
         */
        function parseCSV(text) {
            const cleanText = text.trim().replace(/^\uFEFF/, '');
            const lines = cleanText.split(/\r\n|\n/);
            if (lines.length < 2) return [];
            const headers = lines[0].split(',').map(h => h.trim());
            const data = [];
            for (let i = 1; i < lines.length; i++) {
                const line = lines[i];
                if (line.trim() === '') continue;
                const obj = {};
                const values = line.match(/("([^"]|"")*"|[^,]*)(,|$)/g);
                if (!values || values.length < headers.length) continue;
                for (let j = 0; j < headers.length; j++) {
                    let value = values[j];
                    if (value.endsWith(',')) value = value.slice(0, -1);
                    if (value.startsWith('"') && value.endsWith('"')) value = value.slice(1, -1);
                    value = value.replace(/""/g, '"');
                    obj[headers[j]] = value;
                }
                data.push(obj);
            }
            return data;
        }

        /**
         * スプレッドシートから単語データを非同期で読み込み、アプリを初期化します。
         */
        async function loadWordsAndInitApp() {
            try {
                const response = await fetch(SPREADSHEET_URL);
                if (!response.ok) throw new Error(`Network response was not ok (status: ${response.status})`);
                const csvText = await response.text();
                words = parseCSV(csvText);
                if (words.length === 0) throw new Error('スプレッドシートから単語を読み込めませんでした。');
                
                document.getElementById('loadingMessage').style.display = 'none';
                document.getElementById('appContent').classList.remove('hidden');
                initializeApp();
            } catch (error) {
                console.error('単語の読み込みに失敗しました:', error);
                document.getElementById('loadingMessage').innerHTML = `
                    <p class="text-xl text-red-600">単語の読み込みに失敗しました。</p>
                    <p class="text-sm text-slate-500 mt-2">スプレッドシートが「リンクを知っている全員」に公開されているか確認してください。</p>
                `;
            }
        }

        /**
         * カテゴリ選択のプルダウンメニューを動的に生成します
         */
        function populateCategories() {
            const categories = [...new Set(words.map(w => w.Level))];
            const select = document.getElementById("categorySelect");
            while (select.options.length > 1) select.remove(1);
            categories.sort();
            categories.forEach(cat => {
                const option = document.createElement("option");
                option.value = cat;
                option.textContent = cat;
                select.appendChild(option);
            });
        }
        
        /**
         * シャッフル機能のオン・オフを切り替えます
         */
        function toggleShuffle() {
            isShuffleEnabled = document.getElementById('shuffleToggle').checked;
            filterByCategory();
        }

        /**
         * カテゴリによって単語をフィルタリングし、表示順を決定します
         */
        function filterByCategory() {
            const selected = document.getElementById("categorySelect").value;
            filteredWords = (selected === "all")
                ? words.filter(w => !learnedWords.includes(w.英語))
                : words.filter(w => w.Level === selected && !learnedWords.includes(w.英語));

            if (isShuffleEnabled) {
                for (let i = filteredWords.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [filteredWords[i], filteredWords[j]] = [filteredWords[j], filteredWords[i]];
                }
            } else {
                filteredWords.sort((a, b) => a.英語.localeCompare(b.英語));
            }
            currentIndex = 0;
            showWord();
        }

        /**
         * カードに単語を表示します
         */
        function showWord() {
            const wordDisplay = document.getElementById("wordDisplay");
            const translationDisplay = document.getElementById("translationDisplay");
            const toggleBtn = document.getElementById("toggleAnswerBtn");

            if (filteredWords.length === 0) {
                wordDisplay.textContent = "クリア！";
                translationDisplay.textContent = "このカテゴリの単語をすべて覚えました！";
                translationDisplay.style.display = "block";
                return;
            }
            const word = filteredWords[currentIndex];
            wordDisplay.textContent = word.英語;
            translationDisplay.textContent = word.和訳;
            
            // 新しい単語を表示する際は、答えを隠し、ボタンを元に戻します
            translationDisplay.style.display = "none";
            toggleBtn.textContent = "答えを見る";
            toggleBtn.classList.remove('bg-orange-500', 'hover:bg-orange-600');
            toggleBtn.classList.add('bg-blue-600', 'hover:bg-blue-700');
        }

        /**
         * 和訳の表示・非表示を切り替えます
         */
        function toggleTranslation() {
            if (filteredWords.length === 0) return;
            const translationDisplay = document.getElementById("translationDisplay");
            const toggleBtn = document.getElementById("toggleAnswerBtn");
            const isHidden = translationDisplay.style.display === "none";

            if (isHidden) {
                translationDisplay.style.display = "block";
                toggleBtn.textContent = "答えを隠す";
                toggleBtn.classList.remove('bg-blue-600', 'hover:bg-blue-700');
                toggleBtn.classList.add('bg-orange-500', 'hover:bg-orange-600');
            } else {
                translationDisplay.style.display = "none";
                toggleBtn.textContent = "答えを見る";
                toggleBtn.classList.remove('bg-orange-500', 'hover:bg-orange-600');
                toggleBtn.classList.add('bg-blue-600', 'hover:bg-blue-700');
            }
        }

        /**
         * 前の単語へ進みます
         */
        function previousWord() {
            if (filteredWords.length > 0) {
                currentIndex = (currentIndex - 1 + filteredWords.length) % filteredWords.length;
                showWord();
            }
        }

        /**
         * 次の単語へ進みます
         */
        function nextWord() {
            if (filteredWords.length > 0) {
                currentIndex = (currentIndex + 1) % filteredWords.length;
                showWord();
            }
        }

        /**
         * 単語を「覚えた」リストに追加します
         */
        function markLearned() {
            if (filteredWords.length === 0) return;
            const word = filteredWords[currentIndex].英語;
            if (!learnedWords.includes(word)) {
                learnedWords.push(word);
                localStorage.setItem("learnedWords", JSON.stringify(learnedWords));
                updateLearnedList();
                filteredWords.splice(currentIndex, 1);
                if (currentIndex >= filteredWords.length) {
                    currentIndex = 0;
                }
                showWord();
            }
        }

        /**
         * 「覚えた単語一覧」を更新します
         */
        function updateLearnedList() {
            const list = document.getElementById("learnedWords");
            list.innerHTML = "";
            learnedWords.forEach(w => {
                const li = document.createElement("li");
                li.textContent = w;
                list.appendChild(li);
            });
        }

        /**
         * アプリのロジックを初期化する関数
         */
        function initializeApp() {
            populateCategories();
            filterByCategory();
            updateLearnedList();
        }
        
        // アプリを開始します
        loadWordsAndInitApp();
    </script>
</body>
</html>
